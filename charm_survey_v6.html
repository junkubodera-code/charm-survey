<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CharmSurvey - çµ„ç¹”ã‚µãƒ¼ãƒ™ã‚¤ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', 'Segoe UI', sans-serif; background-color: #f5f5f5; color: #333; }
        .admin-container { display: flex; height: 100vh; }
        .sidebar { width: 280px; background-color: #1f4788; color: white; padding: 20px; overflow-y: auto; box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1); }
        .sidebar h2 { font-size: 18px; margin-bottom: 30px; display: flex; align-items: center; gap: 8px; }
        .sidebar-section { margin-bottom: 25px; }
        .sidebar-section-title { font-size: 12px; font-weight: bold; color: #aaa; margin-bottom: 12px; text-transform: uppercase; }
        .sidebar-item { padding: 10px 15px; margin-bottom: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        .sidebar-item:hover { background-color: rgba(255, 255, 255, 0.1); }
        .sidebar-item.active { background-color: #0056b3; }
        .sidebar-item.add-btn { background-color: #28a745; text-align: center; font-weight: bold; }
        .sidebar-item.add-btn:hover { background-color: #218838; }
        .main-content { flex: 1; overflow-y: auto; padding: 40px; background-color: #fff; }
        .company-header { margin-bottom: 40px; }
        .company-header h1 { font-size: 32px; color: #1f4788; margin-bottom: 5px; }
        .company-header p { color: #666; font-size: 14px; }
        .dashboard-title { font-size: 28px; color: #1f4788; margin-bottom: 10px; }
        .response-count { font-size: 14px; color: #999; margin-bottom: 30px; }
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 30px; }
        .tab { padding: 12px 20px; cursor: pointer; color: #666; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab.active { color: #1f4788; border-bottom-color: #1f4788; }
        .tab:hover { color: #1f4788; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #333; font-size: 14px; }
        .form-group input[type="text"], .form-group input[type="date"], .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #1f4788; box-shadow: 0 0 5px rgba(31, 71, 136, 0.3); }
        .rating-group { display: flex; gap: 10px; margin-top: 8px; }
        .rating-option { flex: 1; text-align: center; padding: 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.3s; font-size: 12px; }
        .rating-option:hover { border-color: #1f4788; background-color: #f0f5ff; }
        .rating-option input { display: none; }
        .rating-option input:checked + label { color: #1f4788; font-weight: bold; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        .btn-primary { background-color: #1f4788; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; color: white; margin-left: 10px; }
        .btn-secondary:hover { background-color: #5a6268; }
        .question-block { background: white; padding: 20px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #1f4788; }
        .question-number { font-weight: bold; color: #1f4788; margin-bottom: 10px; }
        .qr-container { text-align: center; margin-top: 20px; }
        #qrcode { display: inline-block; border: 1px solid #ddd; padding: 10px; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        table thead { background-color: #1f4788; color: white; }
        table th, table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        table tr:hover { background-color: #f5f5f5; }
        .link-section { background: #f0f5ff; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        .link-section h4 { color: #1f4788; margin-bottom: 10px; }
        .link-input { display: flex; gap: 10px; margin-bottom: 10px; }
        .link-input input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .link-input button { padding: 10px 15px; background-color: #1f4788; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .link-input button:hover { background-color: #0056b3; }
        .hidden { display: none; }
        .inline-add { display: flex; gap: 10px; margin-bottom: 15px; }
        .inline-add input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .inline-add button { padding: 10px 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .inline-add button:hover { background-color: #218838; }
        .report-container { max-width: 100%; }
        .slides-viewer { width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 20px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; }
        .slides-controls { display: flex; gap: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>
<div class="admin-container">
    <div class="sidebar">
        <h2>ğŸ¯ CharmSurvey</h2>
        <div class="sidebar-section">
            <div class="sidebar-section-title">ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š</div>
            <input type="text" id="domainInput" placeholder="https://charm-survey-production.up.railway.app" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #555; border-radius: 4px; color: black;">
            <button id="saveDomainBtn" style="width: 100%; padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">ä¿å­˜</button>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-section-title">ä¼æ¥­ç®¡ç†</div>
            <div id="companyList"></div>
        </div>
    </div>
    <div class="main-content">
        <div class="company-header">
            <h1 id="companyName">ã‚µãƒ³ãƒ—ãƒ«æ ªå¼ä¼šç¤¾</h1>
        </div>
        <div class="dashboard-title">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
        <div class="response-count"><span id="responseCount">0</span>åã®å›ç­”è€…</div>
        <div class="tabs">
            <div class="tab active" data-tab="respondents">å›ç­”è€…ç®¡ç†</div>
            <div class="tab" data-tab="questions">è³ªå•ç®¡ç†</div>
            <div class="tab" data-tab="report">ãƒ¬ãƒãƒ¼ãƒˆ</div>
        </div>
        <div id="respondents-tab" class="tab-content">
            <div class="link-section">
                <h4>ğŸ”— å›ç­”è€…å°‚ç”¨ãƒªãƒ³ã‚¯</h4>
                <p style="margin-bottom: 10px; color: #666; font-size: 13px;">ã“ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ä»˜ã—ã¦ãã ã•ã„ã€‚å¾“æ¥­å“¡ãŒã“ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã‚µãƒ¼ãƒ™ã‚¤ã«å›ç­”ã§ãã¾ã™ã€‚</p>
                <div class="link-input">
                    <input type="text" id="surveyLink" readonly>
                    <button onclick="copySurveyLink()">ã‚³ãƒ”ãƒ¼</button>
                    <button onclick="previewSurvey()">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                </div>
                <div class="qr-container"><div id="qrcode"></div></div>
            </div>
            <h3 style="color: #1f4788; margin-top: 30px; margin-bottom: 15px;">æ–°è¦ä¼æ¥­è¿½åŠ </h3>
            <div class="inline-add">
                <input type="text" id="newCompanyName" placeholder="ä¼æ¥­å">
                <button onclick="addNewCompanyInline()">è¿½åŠ </button>
            </div>
            <h3 style="color: #1f4788; margin-top: 30px; margin-bottom: 15px;">å›ç­”è€…ä¸€è¦§</h3>
            <table><thead><tr><th>å›ç­”è€…å</th><th>éƒ¨ç½²</th><th>å½¹è·</th><th>å…¥ç¤¾æ—¥</th><th>å›ç­”çŠ¶æ³</th></tr></thead><tbody id="respondentsList"></tbody></table>
        </div>
        <div id="questions-tab" class="tab-content hidden">
            <h3 style="color: #1f4788; margin-bottom: 15px;">ã‚µãƒ¼ãƒ™ã‚¤è³ªå•ä¸€è¦§</h3>
            <div id="questionsList"></div>
        </div>
        <div id="report-tab" class="tab-content hidden">
            <h3 style="color: #1f4788; margin-bottom: 15px;">ãƒ¬ãƒãƒ¼ãƒˆ</h3>
            <div class="report-container">
                <div class="slides-controls">
                    <button id="prevSlide" class="btn btn-primary" onclick="previousSlide()">â† å‰ã¸</button>
                    <span id="slideInfo" style="padding: 10px 20px; background: #f5f5f5; border-radius: 4px;">1 / 6</span>
                    <button id="nextSlide" class="btn btn-primary" onclick="nextSlide()">æ¬¡ã¸ â†’</button>
                    <button id="downloadPdf" class="btn btn-primary" onclick="downloadReportPDF()">ğŸ“¥ PDF</button>
                    <button id="downloadSlides" class="btn btn-primary" onclick="downloadReportSlides()">ğŸ“¥ Slides</button>
                </div>
                <div class="slides-viewer" id="slidesViewer">
                    <div id="slideContent" style="width: 90%; text-align: left;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="surveyMode" class="hidden">
    <div style="max-width: 800px; margin: 0 auto; padding: 40px 20px;">
        <div style="text-align: center; margin-bottom: 40px;">
            <h2 id="surveyTitle" style="color: #1f4788; margin-bottom: 5px;">çµ„ç¹”ã‚µãƒ¼ãƒ™ã‚¤</h2>
            <p id="surveyCompany" style="color: #666; font-size: 14px;"></p>
        </div>
        <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span id="progressQuestion" style="font-weight: bold;">Q1 / 5</span>
                    <span id="progressPercent" style="color: #999; font-size: 13px;">ç´„3åˆ†ã§å®Œäº†</span>
                </div>
                <div style="background: #eee; height: 4px; border-radius: 2px; overflow: hidden;">
                    <div id="progressBar" style="background: #1f4788; height: 100%; width: 20%; transition: width 0.3s;"></div>
                </div>
            </div>
            <form id="surveyForm">
                <div id="personalInfoSection">
                    <h3 style="color: #1f4788; margin-bottom: 20px; font-size: 16px;">ã¾ãšã€ã‚ãªãŸã®æƒ…å ±ã‚’æ•™ãˆã¦ãã ã•ã„</h3>
                    <div class="form-group">
                        <label>åå‰</label>
                        <input type="text" id="respondentName" required>
                    </div>
                    <div class="form-group">
                        <label>å…¥ç¤¾å¹´æœˆæ—¥</label>
                        <input type="date" id="joinDate" required>
                    </div>
                    <div class="form-group">
                        <label>éƒ¨ç½²</label>
                        <input type="text" id="department" placeholder="ä¾‹ï¼šå–¶æ¥­éƒ¨ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨" required>
                    </div>
                    <div class="form-group">
                        <label>å½¹è·</label>
                        <input type="text" id="position" placeholder="ä¾‹ï¼šå–¶æ¥­éƒ¨é•·" required>
                    </div>
                    <button type="button" id="startSurveyBtn" class="btn btn-primary" style="width: 100%; margin-top: 20px;">å›ç­”ã‚’é–‹å§‹ã™ã‚‹</button>
                </div>
                <div id="questionsSection" class="hidden"></div>
                <button type="submit" id="submitBtn" class="btn btn-primary" style="width: 100%; display: none; margin-top: 20px;">å›ç­”ã‚’é€ä¿¡ã™ã‚‹</button>
            </form>
        </div>
    </div>
</div>

<script>
const surveyQuestions = [
    { id: 1, title: "å½“ç¤¾ã®ã‚µãƒ¼ãƒ“ã‚¹ï¼äº‹æ¥­ã‚’ä¸€è¨€ã§è¡¨ã™ã¨ï¼Ÿ", textQuestion: "è¨˜è¿°ï¼š20ã€œ30æ–‡å­—", textPlaceholder: "", textMaxLength: 100, ratingQuestion: "ä¸Šè¨˜ã®å›ç­”ã¯ã©ã‚Œãã‚‰ã„è‡ªä¿¡ã‚’æŒã£ã¦è¨€ãˆã¾ã™ã‹ï¼Ÿ", ratingOptions: ["â‘ å…¨ãè¨€ãˆãªã„", "â‘¡ã‚ã¾ã‚Šè¨€ãˆãªã„", "â‘¢ã‚ã‚‹ç¨‹åº¦è¨€ãˆã‚‹", "â‘£ã‹ãªã‚Šè¨€ãˆã‚‹", "â‘¤æ˜ç¢ºã«è¨€ãˆã‚‹"] },
    { id: 2, title: "å½“ç¤¾ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ã„ã¦ã€ä»–ç¤¾ã§ã¯ãªãå½“ç¤¾ãŒé¸ã°ã‚Œã‚‹ç†ç”±ã‚’èª¬æ˜ã§ãã¾ã™ã‹ï¼Ÿ", textQuestion: "è¨˜è¿°ï¼š300æ–‡å­—ä»¥å†…", textPlaceholder: "", textMaxLength: 300, ratingQuestion: "ä¸Šè¨˜ã®å›ç­”ã¯ã©ã‚Œãã‚‰ã„è‡ªä¿¡ã‚’æŒã£ã¦è¨€ãˆã¾ã™ã‹ï¼Ÿ", ratingOptions: ["â‘ å…¨ãèª¬æ˜ã§ããªã„", "â‘¡ã‚ã¾ã‚Šèª¬æ˜ã§ããªã„", "â‘¢ã‚ã‚‹ç¨‹åº¦èª¬æ˜ã§ãã‚‹", "â‘£ã‹ãªã‚Šèª¬æ˜ã§ãã‚‹", "â‘¤å¼·ãè‡ªä¿¡ã‚’æŒã£ã¦èª¬æ˜ã§ãã‚‹"] },
    { id: 3, title: "ç¤¾å†…ã§å½“ç¤¾ã‚µãƒ¼ãƒ“ã‚¹ã®é­…åŠ›ã‚’èªã‚‹éš›ã€ä½¿ã‚ã‚Œã¦ã„ã‚‹è¨€è‘‰ã‚„è¡¨ç¾ã¯ã©ã®ç¨‹åº¦å…±é€šã—ã¦ã„ã‚‹ã¨æ„Ÿã˜ã¾ã™ã‹ï¼Ÿ", textQuestion: "è¨˜è¿°ï¼š300æ–‡å­—ä»¥å†…ï¼ˆç†ç”±ï¼‰", textPlaceholder: "", textMaxLength: 300, ratingQuestion: "ä¸Šè¨˜ã®å›ç­”ã¯ã©ã‚Œãã‚‰ã„è‡ªä¿¡ã‚’æŒã£ã¦è¨€ãˆã¾ã™ã‹ï¼Ÿ", ratingOptions: ["â‘ å…¨ãæƒã£ã¦ã„ãªã„", "â‘¡ã‚ã¾ã‚Šæƒã£ã¦ã„ãªã„", "â‘¢ã‚ã‚‹ç¨‹åº¦æƒã£ã¦ã„ã‚‹", "â‘£ã»ã¼åŒã˜è¨€è‘‰ã§èªã‚‰ã‚Œã¦ã„ã‚‹", "â‘¤éå¸¸ã«æƒã£ã¦ã„ã‚‹"] },
    { id: 4, title: "å½“ç¤¾ã‚µãƒ¼ãƒ“ã‚¹ãŒã€é¡§å®¢ã®æ„æ€æ±ºå®šã‚„è¡Œå‹•ã‚’å¤‰ãˆãŸäº‹ä¾‹ã‚’æ€ã„æµ®ã‹ã¹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã‹ï¼Ÿ", textQuestion: "è¨˜è¿°ï¼š300æ–‡å­—ä»¥å†…ï¼ˆå†…å®¹/ç†ç”±ï¼‰", textPlaceholder: "", textMaxLength: 300, ratingQuestion: "ä¸Šè¨˜ã®å›ç­”ã¯ã©ã‚Œãã‚‰ã„è‡ªä¿¡ã‚’æŒã£ã¦è¨€ãˆã¾ã™ã‹ï¼Ÿ", ratingOptions: ["â‘ å…¨ãæ€ã„æµ®ã‹ã°ãªã„", "â‘¡ã‚ã¾ã‚Šæ€ã„æµ®ã‹ã°ãªã„", "â‘¢ã‚ã‚‹ç¨‹åº¦æ€ã„æµ®ã‹ã¶", "â‘£è¤‡æ•°æ€ã„æµ®ã‹ã¶", "â‘¤å…·ä½“äº‹ä¾‹ã‚’ã‚‚ã¨ã«æ˜ç¢ºã«æ€ã„æµ®ã‹ã¶"] },
    { id: 5, title: "å½“ç¤¾ã‚µãƒ¼ãƒ“ã‚¹ã®ã€Œå‘ã„ã¦ã„ãªã„ã‚±ãƒ¼ã‚¹ã€ã‚„ã€Œå¼±ã¿ãƒ»èª²é¡Œã€ã‚’èª¬æ˜ã§ãã¾ã™ã‹ï¼Ÿ", textQuestion: "è¨˜è¿°ï¼š300æ–‡å­—ä»¥å†…", textPlaceholder: "", textMaxLength: 300, ratingQuestion: "ä¸Šè¨˜ã®å›ç­”ã¯ã©ã‚Œãã‚‰ã„è‡ªä¿¡ã‚’æŒã£ã¦è¨€ãˆã¾ã™ã‹ï¼Ÿ", ratingOptions: ["â‘ å…¨ãèª¬æ˜ã§ããªã„", "â‘¡ã‚ã¾ã‚Šèª¬æ˜ã§ããªã„", "â‘¢å°‘ã—èª¬æ˜ã§ãã‚‹", "â‘£ã‚ã‚‹ç¨‹åº¦èª¬æ˜ã§ãã‚‹", "â‘¤æ˜ç¢ºã«èª¬æ˜ã§ãã‚‹"] }
];

let baseDomain = 'https://charm-survey-production.up.railway.app';
let companies = [];
let currentCompanyId = 'sample-corp';
let isAdminMode = true;
let surveyResponses = [];
let currentQuestionIndex = 0;
let currentSlide = 1;

document.addEventListener('DOMContentLoaded', function() {
    const params = new URLSearchParams(window.location.search);
    if (params.get('mode') === 'survey') {
        enterSurveyMode(params.get('company'));
    } else {
        initializeAdmin();
    }
});

function initializeAdmin() {
    isAdminMode = true;
    loadDomain();
    initializeCompanies();
    loadRespondents();
    setupEventListeners();
}

function setupEventListeners() {
    document.getElementById('saveDomainBtn').addEventListener('click', saveDomainSetting);
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            switchTab(tabName);
        });
    });
    document.getElementById('startSurveyBtn').addEventListener('click', startSurvey);
    document.getElementById('surveyForm').addEventListener('submit', submitSurvey);
}

function loadDomain() {
    const stored = localStorage.getItem('domainSetting');
    if (stored) {
        baseDomain = stored;
    }
    document.getElementById('domainInput').value = baseDomain;
    generateSurveyLink();
}

function saveDomainSetting() {
    const domain = document.getElementById('domainInput').value.trim();
    if (!domain) {
        alert('ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    baseDomain = domain;
    localStorage.setItem('domainSetting', domain);
    generateSurveyLink();
}

function generateSurveyLink() {
    const link = `${baseDomain}/?mode=survey&company=${currentCompanyId}`;
    document.getElementById('surveyLink').value = link;
    document.getElementById('qrcode').innerHTML = '';
    new QRCode(document.getElementById('qrcode'), {
        text: link,
        width: 200,
        height: 200
    });
}

function copySurveyLink() {
    const link = document.getElementById('surveyLink').value;
    navigator.clipboard.writeText(link).then(() => {
        alert('ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
    });
}

function previewSurvey() {
    const link = document.getElementById('surveyLink').value;
    window.open(link, '_blank');
}

function initializeCompanies() {
    const defaultCompanies = [
        { id: 'sample-corp', name: 'ã‚µãƒ³ãƒ—ãƒ«æ ªå¼ä¼šç¤¾' }
    ];
    companies = JSON.parse(localStorage.getItem('companies')) || defaultCompanies;
    localStorage.setItem('companies', JSON.stringify(companies));
    renderCompanyList();
    selectCompany('sample-corp');
}

function renderCompanyList() {
    const listHTML = companies.map(company => `
        <div class="sidebar-item ${company.id === currentCompanyId ? 'active' : ''}" onclick="selectCompany('${company.id}')">
            ${company.name}
        </div>
    `).join('');
    document.getElementById('companyList').innerHTML = listHTML;
}

function selectCompany(companyId) {
    currentCompanyId = companyId;
    const company = companies.find(c => c.id === companyId);
    if (company) {
        document.getElementById('companyName').textContent = company.name;
    }
    renderCompanyList();
    generateSurveyLink();
    loadRespondents();
}

function addNewCompanyInline() {
    const name = document.getElementById('newCompanyName').value.trim();
    if (!name) {
        alert('ä¼æ¥­åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    const id = name.toLowerCase().replace(/\s/g, '-');
    companies.push({ id, name });
    localStorage.setItem('companies', JSON.stringify(companies));
    document.getElementById('newCompanyName').value = '';
    initializeCompanies();
}

function loadRespondents() {
    const storedRespondents = JSON.parse(localStorage.getItem(`respondents_${currentCompanyId}`)) || [];
    const tbody = document.getElementById('respondentsList');
    tbody.innerHTML = storedRespondents.map(r => `
        <tr>
            <td>${r.name}</td>
            <td>${r.department}</td>
            <td>${r.position}</td>
            <td>${r.joinDate}</td>
            <td style="color: #28a745;">å›ç­”æ¸ˆã¿</td>
        </tr>
    `).join('');
    document.getElementById('responseCount').textContent = storedRespondents.length;
}

function addSampleData() {
    const sampleRespondents = [
        { name: 'ç”°ä¸­å¤ªéƒ', department: 'å–¶æ¥­éƒ¨', position: 'å–¶æ¥­èª²é•·', joinDate: '2020-01-15', answers: [{ questionId: 1, text: 'ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ™ãƒ¼ã‚¹ã®ã‚µãƒ¼ãƒ™ã‚¤ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ', rating: '5' }, { questionId: 2, text: 'ä½¿ã„ã‚„ã™ã„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨è±Šå¯Œãªæ©Ÿèƒ½', rating: '4' }, { questionId: 3, text: 'ç¤¾å†…ã§ç©æ¥µçš„ã«æ´»ç”¨ã•ã‚Œã¦ã„ã‚‹', rating: '5' }, { questionId: 4, text: 'é¡§å®¢æº€è¶³åº¦ãŒå‘ä¸Šã—ãŸäº‹ä¾‹ãŒã‚ã‚‹', rating: '4' }, { questionId: 5, text: 'åˆæœŸå°å…¥ã‚³ã‚¹ãƒˆã¨å­¦ç¿’æ™‚é–“ãŒå¿…è¦', rating: '3' }] },
        { name: 'éˆ´æœ¨èŠ±å­', department: 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨', position: 'éƒ¨é•·', joinDate: '2019-03-20', answers: [{ questionId: 1, text: 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿åé›†ãƒ„ãƒ¼ãƒ«', rating: '4' }, { questionId: 2, text: 'é«˜ã„æ‹¡å¼µæ€§ã¨ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ€§', rating: '5' }, { questionId: 3, text: 'å®šæœŸçš„ã«ç¤¾å†…ã§å…±æœ‰ã•ã‚Œã¦ã„ã‚‹', rating: '4' }, { questionId: 4, text: 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ã®æ”¹å–„ã«å½¹ç«‹ã£ãŸ', rating: '5' }, { questionId: 5, text: 'ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®æ”¹å–„ãŒå¿…è¦', rating: '2' }] },
        { name: 'ä½è—¤æ¬¡éƒ', department: 'ä¼ç”»éƒ¨', position: 'ä¸»ä»»', joinDate: '2021-07-10', answers: [{ questionId: 1, text: 'çµ„ç¹”ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šã‚·ã‚¹ãƒ†ãƒ ', rating: '3' }, { questionId: 2, text: 'ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒªãƒ–ãƒ³ãªæ„æ€æ±ºå®šã‚’å®Ÿç¾', rating: '4' }, { questionId: 3, text: 'ãƒãƒ¼ãƒ å†…ã§ã®èªè­˜ãŒã°ã‚‰ã¤ããŒã‚ã‚‹', rating: '3' }, { questionId: 4, text: 'éƒ¨é–€æ¨ªæ–­çš„ãªå”æ¥­ãŒå®Ÿç¾ã—ãŸ', rating: '4' }, { questionId: 5, text: 'UI/UXã®æ”¹å–„ä½™åœ°ãŒã‚ã‚‹', rating: '2' }] }
    ];
    localStorage.setItem(`respondents_${currentCompanyId}`, JSON.stringify(sampleRespondents));
    loadRespondents();
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    document.getElementById(tabName + '-tab').classList.remove('hidden');
    event.target.classList.add('active');
    if (tabName === 'questions') {
        displayQuestions();
    }
    if (tabName === 'report') {
        displayReport();
    }
}

function displayQuestions() {
    const html = surveyQuestions.map((q, idx) => `
        <div class="question-block">
            <div class="question-number">Q${q.id}. ${q.title}</div>
            <div class="question-sub">1. ${q.textQuestion}</div>
            <div class="question-sub">2. 5æ®µéšï¼š${q.ratingOptions.join(' ')}</div>
            <button class="btn btn-primary" onclick="editQuestion(${idx})" style="margin-top: 10px;">ç·¨é›†</button>
        </div>
    `).join('');
    document.getElementById('questionsList').innerHTML = html;
}

function editQuestion(idx) {
    const q = surveyQuestions[idx];
    const newTitle = prompt('è³ªå•ã‚’ç·¨é›†ã—ã¦ãã ã•ã„:', q.title);
    if (newTitle && newTitle !== q.title) {
        surveyQuestions[idx].title = newTitle;
        localStorage.setItem('surveyQuestions', JSON.stringify(surveyQuestions));
        displayQuestions();
    }
}

function displayReport() {
    const respondents = JSON.parse(localStorage.getItem(`respondents_${currentCompanyId}`)) || [];

    if (respondents.length === 0) {
        document.getElementById('slideContent').innerHTML = '<p style="color: #999;">å›ç­”ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
    }

    const slides = generateReportSlides(respondents);
    currentSlide = 1;
    renderSlide(slides[currentSlide - 1]);
}

function generateReportSlides(respondents) {
    const slides = [];

    slides.push(`
        <div style="text-align: center; padding: 40px;">
            <h1 style="color: #1f4788; font-size: 32px; margin-bottom: 20px;">çµ„ç¹”ã‚µãƒ¼ãƒ™ã‚¤çµæœãƒ¬ãƒãƒ¼ãƒˆ</h1>
            <p style="color: #666; font-size: 18px;">${document.getElementById('companyName').textContent}</p>
            <p style="color: #999; margin-top: 40px;">å›ç­”è€…æ•°: ${respondents.length}å</p>
        </div>
    `);

    surveyQuestions.forEach((q, idx) => {
        let ratingCounts = [0, 0, 0, 0, 0];
        respondents.forEach(r => {
            const answer = r.answers.find(a => a.questionId === q.id);
            if (answer) {
                ratingCounts[parseInt(answer.rating) - 1]++;
            }
        });

        slides.push(`
            <div style="padding: 20px;">
                <h2 style="color: #1f4788; margin-bottom: 20px;">Q${q.id}. ${q.title}</h2>
                <div style="margin-top: 20px;">
                    ${q.ratingOptions.map((opt, i) => `
                        <div style="margin-bottom: 10px;">
                            <span style="display: inline-block; width: 150px;">${opt}</span>
                            <div style="display: inline-block; width: 300px; background: #ddd; height: 30px; border-radius: 4px; overflow: hidden;">
                                <div style="background: #1f4788; height: 100%; width: ${(ratingCounts[i] / respondents.length * 100)}%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                    ${ratingCounts[i]}å
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `);
    });

    return slides;
}

function renderSlide(content) {
    document.getElementById('slideContent').innerHTML = content;
    document.getElementById('slideInfo').textContent = `${currentSlide} / 6`;
}

function nextSlide() {
    const respondents = JSON.parse(localStorage.getItem(`respondents_${currentCompanyId}`)) || [];
    if (respondents.length === 0) return;
    const slides = generateReportSlides(respondents);
    if (currentSlide < slides.length) {
        currentSlide++;
        renderSlide(slides[currentSlide - 1]);
    }
}

function previousSlide() {
    const respondents = JSON.parse(localStorage.getItem(`respondents_${currentCompanyId}`)) || [];
    if (respondents.length === 0) return;
    const slides = generateReportSlides(respondents);
    if (currentSlide > 1) {
        currentSlide--;
        renderSlide(slides[currentSlide - 1]);
    }
}

function downloadReportPDF() {
    const respondents = JSON.parse(localStorage.getItem(`respondents_${currentCompanyId}`)) || [];
    if (respondents.length === 0) {
        alert('ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }

    const slides = generateReportSlides(respondents);
    const element = document.createElement('div');
    slides.forEach((slide, idx) => {
        const slideDiv = document.createElement('div');
        slideDiv.innerHTML = slide;
        slideDiv.style.pageBreakAfter = 'always';
        slideDiv.style.padding = '20px';
        element.appendChild(slideDiv);
    });

    const opt = {
        margin: 10,
        filename: `${document.getElementById('companyName').textContent}_report.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
    };
    html2pdf().set(opt).from(element).save();
}

function downloadReportSlides() {
    alert('Googleã‚¹ãƒ©ã‚¤ãƒ‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™ã€‚\nãŠæ‰‹æ•°ã§ã™ãŒã€æ‰‹å‹•ã§Googleã‚¹ãƒ©ã‚¤ãƒ‰ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚');
}

function enterSurveyMode(companyId) {
    isAdminMode = false;
    currentCompanyId = companyId || 'sample-corp';
    const company = companies.find(c => c.id === currentCompanyId) || { name: 'ã‚µãƒ³ãƒ—ãƒ«æ ªå¼ä¼šç¤¾' };
    document.getElementById('surveyMode').classList.remove('hidden');
    document.querySelector('.admin-container').classList.add('hidden');
    document.getElementById('surveyCompany').textContent = company.name;
}

function renderSurveyQuestions() {
    const section = document.getElementById('questionsSection');
    const html = surveyQuestions.map((q, idx) => `
        <div class="question-block" style="display: ${idx === currentQuestionIndex ? 'block' : 'none'};" id="question-${idx}">
            <div class="question-number">Q${q.id}. ${q.title}</div>
            <div class="form-group">
                <label style="color: #666; font-weight: normal; font-size: 13px;">${q.textQuestion}</label>
                <textarea id="text-answer-${idx}" placeholder="${q.textPlaceholder}" maxlength="${q.textMaxLength}" required></textarea>
            </div>
            <div class="form-group">
                <label style="color: #666; font-weight: normal; font-size: 13px;">${q.ratingQuestion}</label>
                <div class="rating-group">
                    ${q.ratingOptions.map((opt, i) => `
                        <label class="rating-option">
                            <input type="radio" name="rating-${idx}" value="${i+1}" required>
                            <span style="font-size: 12px;">${opt}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                ${idx > 0 ? `<button type="button" class="btn btn-secondary" onclick="prevQuestion()">æˆ»ã‚‹</button>` : ''}
                <button type="button" class="btn btn-primary" onclick="nextQuestion()" style="flex: 1;">${idx === surveyQuestions.length - 1 ? 'å®Œäº†' : 'æ¬¡ã¸'}</button>
            </div>
        </div>
    `).join('');
    section.innerHTML = html;
    section.classList.remove('hidden');
    document.getElementById('personalInfoSection').classList.add('hidden');
    document.getElementById('submitBtn').style.display = 'none';
}

function startSurvey() {
    const name = document.getElementById('respondentName').value.trim();
    const department = document.getElementById('department').value.trim();
    const position = document.getElementById('position').value.trim();
    const joinDate = document.getElementById('joinDate').value;

    if (!name || !department || !position || !joinDate) {
        alert('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    currentQuestionIndex = 0;
    renderSurveyQuestions();
    updateProgress();
}

function nextQuestion() {
    if (currentQuestionIndex < surveyQuestions.length - 1) {
        currentQuestionIndex++;
        renderSurveyQuestions();
        updateProgress();
    } else {
        submitSurvey();
    }
}

function prevQuestion() {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderSurveyQuestions();
        updateProgress();
    }
}

function updateProgress() {
    const total = surveyQuestions.length;
    const percent = ((currentQuestionIndex + 1) / total) * 100;
    document.getElementById('progressQuestion').textContent = `Q${currentQuestionIndex + 1} / ${total}`;
    document.getElementById('progressBar').style.width = percent + '%';
}

function submitSurvey() {
    const responses = {
        name: document.getElementById('respondentName').value,
        department: document.getElementById('department').value,
        position: document.getElementById('position').value,
        joinDate: document.getElementById('joinDate').value,
        answers: []
    };

    surveyQuestions.forEach((q, idx) => {
        responses.answers.push({
            questionId: q.id,
            text: document.getElementById(`text-answer-${idx}`).value,
            rating: document.querySelector(`input[name="rating-${idx}"]:checked`).value
        });
    });

    const storedRespondents = JSON.parse(localStorage.getItem(`respondents_${currentCompanyId}`)) || [];
    storedRespondents.push(responses);
    localStorage.setItem(`respondents_${currentCompanyId}`, JSON.stringify(storedRespondents));

    document.getElementById('surveyForm').innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <h2 style="color: #28a745; margin-bottom: 20px;">âœ“ ã”å›ç­”ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ</h2>
            <p style="color: #666; font-size: 16px;">ã‚ãªãŸã®ã”æ„è¦‹ã¯å¤§åˆ‡ã«ä¿ç®¡ã•ã‚Œã¾ã—ãŸã€‚</p>
        </div>
    `;
}

setTimeout(addSampleData, 500);
</script>
</body>
</html>
